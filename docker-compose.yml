# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2022-2023 Dell Inc, or its subsidiaries.
# Copyright (c) 2022 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
---
version: "3.7"

services:

  opi-nvidia-server:
    build:
      context: .
    ports:
      - "50051:50051"
    networks:
      - opi
    command: /opi-nvidia-bridge -port=50051 -spdk_addr /var/tmp/spdk.sock
    healthcheck:
      test: grpcurl -plaintext localhost:50051 list || exit 1

  opi-test:
    image: docker.io/namely/grpc-cli
    networks:
      - opi
    depends_on:
      opi-nvidia-server:
        condition: service_healthy
    command: ls opi-nvidia-server:50051 opi_api.storage.v1.FrontendNvmeService -l

  opi-client:
    image: docker.io/opiproject/godpu:main
    networks:
      - opi
    depends_on:
      opi-nvidia-server:
        condition: service_healthy
    command: storagetest --addr=opi-nvidia-server:50051

networks:
  opi:
